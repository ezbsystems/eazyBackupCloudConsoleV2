# Windows Agent – Build & Quick Test Guide

This document shows how to build the Windows agent on the Linux dev server and exercise it on a Windows VM using the new agent APIs. It also includes SQL snippets to seed a test agent and job.

## Prerequisites
- DB schema changes applied from `AGENT_SCHEMA.sql` (agents table, `local_agent` source type, optional `agent_uuid` binding on jobs).
- Cloud backup uses **UUIDv7** for `job_id` and `run_id` at all API boundaries; stored as `BINARY(16)` in MySQL.
- Agent API endpoints deployed:
  - `agent_fetch_jobs.php`
  - `agent_start_run.php`
  - `agent_update_run.php`
  - `agent_push_events.php`
  - `agent_register.php` (placeholder)
- Outbound HTTPS from the Windows VM to the WHMCS host.

## Build the Windows binary (Linux dev server)
```bash
cd /var/www/eazybackup.ca/e3-backup-agent
make build-agent-windows
# Output: bin/e3-backup-agent.exe
```

## Seed the database for a test agent and job
Adjust IDs/paths as needed.

### Insert a test agent
```sql
INSERT INTO s3_cloudbackup_agents
  (client_id, agent_uuid, agent_token, hostname, status)
VALUES
  (1234, '018f7c8e-8b9d-7d1f-8e57-3f2224c3b6d8', 'RANDOM_LONG_TOKEN', 'test-windows-vm', 'active');
```

### Create a `local_agent` job for that client
Example: sync from local path `C:\Data` to bucket/prefix.
```sql
INSERT INTO s3_cloudbackup_jobs
  (job_id, client_id, s3_user_id, name, source_type, agent_uuid,
   source_display_name, source_config_enc, source_path,
   dest_bucket_id, dest_prefix,
   backup_mode, encryption_enabled, validation_mode,
   schedule_type, schedule_time, schedule_weekday,
   retention_mode, retention_value,
   notify_on_success, notify_on_warning, notify_on_failure,
   status)
VALUES
  (UUID_TO_BIN('018f7c8c-5cf0-7ad8-9f2b-8c58a7e7b2d6'), 1234, 1, 'Local Agent Test', 'local_agent', '018f7c8e-8b9d-7d1f-8e57-3f2224c3b6d8',
   'Local Path', '', 'C:\\Data',
   10, 'agent-test/',
   'sync', 0, 'none',
   'manual', NULL, NULL,
   'none', NULL,
   0, 1, 1,
   'active');
```

Notes:
- `source_config_enc` can remain empty for simple local-path jobs; fill as needed for include/exclude rules later.
- `dest_bucket_id` and `dest_prefix` should match an existing bucket the client can access.
- Set `agent_uuid` to bind the job to a specific enrolled agent.

## Prepare the Windows VM
1) Copy `bin/e3-backup-agent.exe` to the VM (e.g., `C:\Program Files\E3Backup\`).
2) Create `C:\ProgramData\E3Backup\agent.conf` (YAML):
   ```yaml
   client_id: 1234
   agent_uuid: "018f7c8e-8b9d-7d1f-8e57-3f2224c3b6d8"
   agent_token: "RANDOM_LONG_TOKEN"
   api_base_url: "https://your-whmcs-host/modules/addons/cloudstorage/api"
   poll_interval_secs: 30
   ```
3) Ensure the VM can reach the WHMCS host over HTTPS.

## Run the agent (foreground for initial testing)
From an elevated PowerShell or CMD in the directory containing the exe:
```powershell
e3-backup-agent.exe -config C:\ProgramData\E3Backup\agent.conf
```
You should see startup logging and periodic job fetches. With a `local_agent` job present, it will enumerate it (current runner prototype fetches and logs jobs; fuller execution wiring follows in later steps).

## UUIDv7 cutover verification

See [CLOUDBACKUP_UUIDV7_CUTOVER.md](CLOUDBACKUP_UUIDV7_CUTOVER.md) for release notes and manual API smoke commands. Checklist:

- [ ] Numeric `job_id` rejected by `cloudbackup_start_run.php`
- [ ] Numeric `run_id` rejected by `agent_update_run.php`
- [ ] UUID job/run flow passes create → run → progress → cancel

## Verify connectivity
- DB: `s3_cloudbackup_agents.last_seen_at` updates on fetch calls.
- API: `agent_fetch_jobs.php` returns the job list when called with headers `X-Agent-UUID` and `X-Agent-Token`.
- Once run execution is wired, check `s3_cloudbackup_runs` and `s3_cloudbackup_run_events` for progress.

## Windows service mode (beta)
- Install service: `e3-backup-agent.exe -service install -config C:\ProgramData\E3Backup\agent.conf`
- Start service: `e3-backup-agent.exe -service start`
- Stop service: `e3-backup-agent.exe -service stop`
- Uninstall service: `e3-backup-agent.exe -service uninstall`

## Installer outline (for later packaging)
When ready to ship an installer (Inno Setup/NSIS/MSI), include:
- Files: `e3-backup-agent.exe`, a per-client `agent.conf` (generated by the portal), optional log directory creation.
- Actions: register Windows service `e3-backup-agent` pointing to the exe with `-config "C:\ProgramData\E3Backup\agent.conf"`; set start type to Automatic (Delayed) and run under LocalSystem or a designated service account.
- Post-install: start the service; optionally place a Start Menu shortcut to a “status” log viewer or to open the WHMCS dashboard.

## UI hook (agents)
- The client “Agents” page should call:
  - `agent_list.php` to list agents and last_seen.
  - `agent_create.php` to generate a token + agent_conf payload for copy/paste.
  - `agent_disable.php` to disable/revoke an agent.
- Expose the agent download link and show the returned `agent_conf` for the user to save as `agent.conf`.

