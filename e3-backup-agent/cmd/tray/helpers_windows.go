//go:build windows

package main

import (
	"bytes"
	"crypto/rand"
	"encoding/binary"
	"encoding/hex"
	"fmt"
	"os"
	"path/filepath"
)

// eazybackupLogoSVG is embedded as a string so we don't need to ship a separate file for the enroll UI.
const eazybackupLogoSVG = `<?xml version="1.0" encoding="utf-8"?>
<svg width="1370px" height="273px" viewBox="0 0 1370 273" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">
  <desc>Created with Lunacy</desc>
  <defs>
    <path d="M0 0L1370 0L1370 273L0 273L0 0Z" id="path_1" />
    <clipPath id="mask_1">
      <use xlink:href="#path_1" />
    </clipPath>
  </defs>
  <g id="eazybackup-logo">
    <path d="M0 0L1370 0L1370 273L0 273L0 0Z" id="Background" fill="none" stroke="none" />
    <g clip-path="url(#mask_1)">
      <path d="M961.718 178.944L965.558 178.944C974.778 178.944 981.428 174.848 981.428 161.792L981.428 120.576L1020.6 167.936C1027 176.64 1034.42 179.456 1041.08 179.456C1052.6 179.456 1061.82 168.96 1060.79 167.168L1016.25 112.64L1055.67 63.744C1056.7 61.952 1047.99 51.456 1036.47 51.456C1030.07 51.456 1022.39 54.528 1016.5 62.976L981.428 107.264L981.428 28.928C981.428 5.632 969.658 0 958.898 0C951.738 0 945.338 2.816 945.338 4.096L945.338 161.792C945.338 175.104 951.988 178.944 961.718 178.944ZM547.892 177.92L601.652 177.92C648.244 177.92 668.468 162.816 668.468 130.816C668.468 110.848 657.204 95.488 632.628 89.856C651.828 84.48 662.324 73.216 662.324 54.528C662.324 27.392 642.1 12.288 604.724 12.288L547.892 12.288C535.604 12.288 528.18 19.968 528.18 33.28L528.18 156.928C528.18 170.24 535.604 177.92 547.892 177.92ZM565.556 81.92L565.556 40.448L595.764 40.448C614.196 40.448 623.412 47.104 623.412 60.672C623.412 73.984 613.172 81.92 595.764 81.92L565.556 81.92ZM67.584 181.248C102.4 181.248 121.6 166.144 121.6 152.576C121.6 138.24 104.448 135.936 104.192 136.448C98.304 146.432 87.808 154.88 68.864 154.88C49.408 154.88 35.072 143.872 32.512 125.184L118.784 125.184C125.44 125.184 127.232 121.6 127.488 115.2L127.488 112.64C127.488 76.032 102.144 50.176 65.28 50.176C27.392 50.176 0 78.336 0 116.48C0 155.904 26.88 181.248 67.584 181.248ZM177.301 180.736C195.733 180.736 211.605 173.056 220.565 160C222.613 173.568 230.293 179.712 241.813 179.712C248.725 179.712 255.381 177.408 255.381 175.616L255.381 101.632C255.381 68.096 235.925 50.176 196.501 50.176C158.357 50.176 139.925 65.536 139.925 81.152C139.925 97.792 163.221 97.024 163.221 96.512C167.829 86.784 176.789 77.312 194.197 77.312C210.837 77.312 219.797 86.016 219.797 102.144L215.701 102.144C160.917 102.912 135.317 115.968 135.317 144.64C135.317 165.888 151.189 180.736 177.301 180.736ZM764.308 160C755.348 173.056 739.478 180.736 721.048 180.736C694.938 180.736 679.062 165.888 679.062 144.64C679.062 115.968 704.658 102.912 759.448 102.144L763.538 102.144C763.538 86.016 754.578 77.312 737.938 77.312C720.538 77.312 711.578 86.784 706.968 96.512C706.968 97.024 683.668 97.792 683.668 81.152C683.668 65.536 702.098 50.176 740.248 50.176C779.668 50.176 799.128 68.096 799.128 101.632L799.128 175.616C799.128 177.408 792.468 179.712 785.558 179.712C774.038 179.712 766.358 173.568 764.308 160ZM1230.59 227.84L1234.43 227.84C1243.65 227.84 1250.3 223.488 1250.3 210.432L1250.3 158.464C1256.7 171.008 1271.04 181.248 1290.24 181.248C1324.8 181.248 1348.61 154.368 1348.61 115.456C1348.61 75.52 1324.54 50.176 1290.75 50.176C1271.81 50.176 1257.73 59.136 1249.79 73.472C1247.49 56.32 1237.25 51.712 1227.78 51.712C1220.61 51.712 1214.21 54.784 1214.21 55.808L1214.21 210.432C1214.21 223.744 1220.86 227.84 1230.59 227.84ZM931.908 147.712C931.908 159.488 916.038 181.248 878.658 181.248C839.998 181.248 812.868 154.112 812.868 115.456C812.868 77.568 840.518 50.432 878.658 50.432C916.798 50.432 931.908 72.192 931.908 84.224C931.908 98.816 912.708 101.376 911.938 100.096C907.078 88.064 897.858 79.36 880.198 79.36C860.478 79.36 846.148 94.464 846.148 115.456C846.148 136.96 860.478 152.32 880.198 152.32C897.348 152.32 907.078 143.616 911.938 131.584C912.448 130.048 931.908 132.352 931.908 147.712ZM459.565 209.408C454.189 222.976 447.021 227.072 439.085 227.072C428.589 227.072 418.861 218.88 419.885 217.088L440.621 169.984C434.733 169.216 431.149 166.912 428.845 161.792L385.837 62.208C385.069 60.16 394.541 51.712 405.549 51.456C413.997 51.456 421.421 55.552 425.773 69.632L452.909 141.056L476.973 69.888C481.325 55.808 489.005 51.456 496.941 51.456C507.181 51.456 517.165 59.904 516.397 61.696L459.565 209.408ZM1192.75 174.848C1192.75 176.128 1186.6 178.944 1179.18 178.944C1170.22 178.944 1160.23 175.104 1157.42 159.232C1148.71 172.032 1135.91 181.248 1116.46 181.248C1083.69 181.248 1070.12 158.208 1070.12 129.536L1070.12 69.12C1070.12 56.064 1076.78 51.712 1085.99 51.712L1089.83 51.712C1099.31 51.712 1106.22 55.808 1106.22 69.12L1106.22 124.16C1106.22 140.8 1114.67 151.04 1129.77 151.04C1141.8 151.04 1151.53 144.384 1156.65 134.656L1156.65 69.12C1156.65 56.064 1163.31 51.712 1172.78 51.712L1176.36 51.712C1186.09 51.712 1192.75 55.808 1192.75 69.12L1192.75 174.848ZM283.458 177.92L367.17 177.92C377.154 177.92 381.762 173.312 381.762 164.608L381.762 163.072C381.762 154.112 377.154 150.016 367.17 150.016L314.178 150.016L371.522 83.968C377.154 77.824 379.458 75.008 379.458 67.328L379.458 65.536C379.458 59.136 375.362 52.992 365.634 52.992L285.25 52.992C275.266 52.992 270.658 57.6 270.658 66.048L270.658 67.84C270.658 76.8 275.266 80.896 285.25 80.896L333.634 80.896L277.826 145.92C272.194 152.32 269.89 154.88 269.89 163.072L269.89 165.12C269.89 171.52 273.73 177.92 283.458 177.92ZM93.952 104.192C93.184 86.784 82.176 75.264 64.768 75.264C47.872 75.264 35.072 87.296 32.512 104.192L93.952 104.192ZM1250.3 123.904C1250.82 140.8 1264.38 152.576 1281.54 152.576C1300.99 152.576 1313.79 137.728 1313.79 115.712C1313.79 93.952 1300.74 79.104 1281.79 79.104C1266.69 79.104 1255.68 87.04 1250.3 99.584L1250.3 123.904ZM565.556 105.984L565.556 149.76L597.812 149.76C620.34 149.76 629.812 143.104 629.812 127.232C629.812 112.64 619.572 105.984 598.068 105.984L565.556 105.984ZM169.877 142.08C169.877 151.296 177.301 157.184 189.333 157.184C207.253 157.184 219.797 145.408 219.797 129.024L219.797 121.856L213.141 122.112C184.725 122.88 169.877 128.512 169.877 142.08ZM733.078 157.184C721.048 157.184 713.618 151.296 713.618 142.08C713.618 128.512 728.468 122.88 756.888 122.112L763.538 121.856L763.538 129.024C763.538 145.408 750.998 157.184 733.078 157.184Z" transform="translate(7.911987 28.07999)" id="Shape" fill="#FE5000" fill-rule="evenodd" stroke="none" />
    </g>
  </g>
</svg>`

func newUUIDv4() (string, error) {
	var b [16]byte
	if _, err := rand.Read(b[:]); err != nil {
		return "", err
	}
	b[6] = (b[6] & 0x0f) | 0x40
	b[8] = (b[8] & 0x3f) | 0x80
	s := hex.EncodeToString(b[:])
	return fmt.Sprintf("%s-%s-%s-%s-%s", s[0:8], s[8:12], s[12:16], s[16:20], s[20:32]), nil
}

func pngToICO(pngBytes []byte) ([]byte, error) {
	w, h := pngDimensions(pngBytes)
	if w == 0 || h == 0 {
		return nil, fmt.Errorf("invalid png")
	}

	// ICO container with embedded PNG image (Vista+).
	// https://en.wikipedia.org/wiki/ICO_(file_format)
	const headerSize = 6
	const entrySize = 16
	imageOffset := uint32(headerSize + entrySize)

	buf := &bytes.Buffer{}
	// ICONDIR
	_ = binary.Write(buf, binary.LittleEndian, uint16(0)) // reserved
	_ = binary.Write(buf, binary.LittleEndian, uint16(1)) // type=icon
	_ = binary.Write(buf, binary.LittleEndian, uint16(1)) // count

	// ICONDIRENTRY
	buf.WriteByte(dimByte(w))
	buf.WriteByte(dimByte(h))
	buf.WriteByte(0) // color count
	buf.WriteByte(0) // reserved
	_ = binary.Write(buf, binary.LittleEndian, uint16(1))  // planes
	_ = binary.Write(buf, binary.LittleEndian, uint16(32)) // bitcount
	_ = binary.Write(buf, binary.LittleEndian, uint32(len(pngBytes)))
	_ = binary.Write(buf, binary.LittleEndian, imageOffset)

	// Image data (PNG)
	buf.Write(pngBytes)
	return buf.Bytes(), nil
}

func dimByte(v int) byte {
	// 0 in ICO means 256.
	if v >= 256 {
		return 0
	}
	if v <= 0 {
		return 0
	}
	return byte(v)
}

func pngDimensions(pngBytes []byte) (int, int) {
	// PNG signature (8) + chunk length (4) + "IHDR"(4) + width(4) + height(4)
	if len(pngBytes) < 24 {
		return 0, 0
	}
	sig := []byte{0x89, 'P', 'N', 'G', 0x0d, 0x0a, 0x1a, 0x0a}
	if !bytes.HasPrefix(pngBytes, sig) {
		return 0, 0
	}
	if string(pngBytes[12:16]) != "IHDR" {
		return 0, 0
	}
	w := int(binary.BigEndian.Uint32(pngBytes[16:20]))
	h := int(binary.BigEndian.Uint32(pngBytes[20:24]))
	return w, h
}

func (a *trayApp) loadIconBytes() []byte {
	exe, err := os.Executable()
	if err != nil {
		return nil
	}
	dir := filepath.Dir(exe)

	// Prefer prebuilt ICO if installer provides one.
	candidates := []string{
		filepath.Join(dir, "tray_logo.ico"),
		filepath.Join(dir, "tray_logo-drk-orange.ico"),
		filepath.Join(dir, "tray_logo.png"),
		filepath.Join(dir, "tray_logo-drk-orange120x120.png"),
		filepath.Join(dir, "assets", "tray_logo-drk-orange120x120.png"),
	}

	for _, p := range candidates {
		b, err := os.ReadFile(p)
		if err != nil || len(b) == 0 {
			continue
		}
		// If already ICO, just return bytes.
		if len(b) >= 4 && b[0] == 0 && b[1] == 0 && (b[2] == 1 || b[2] == 2) && b[3] == 0 {
			return b
		}
		// Assume PNG and wrap into ICO.
		if ico, err := pngToICO(b); err == nil {
			return ico
		}
	}
	return nil
}


